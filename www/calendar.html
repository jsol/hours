<html>
<head>
<title>Hours</title>
  <link rel="stylesheet" href="css/calendar.css" />

  <script src="js/jquery-1.12.3.min.js"></script>
<script>

const daynames = ['Sun', 'Mon', 'Tue', 'Wen', 'Thu', 'Fri', 'Sat', 'Sun'];
const monthnames = ['January', 'February', 'Mars', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December']
const workingHours = 8

function initSession(setup) {
  const token = localStorage.getItem('authtoken')
  if (token) {
    return setup()
  }

  $('#login').show()
  $('#loginButton').click(() => {
    $.ajax({
      type: 'POST',
      url: '/v1/authenticate',
      data: JSON.stringify({
        userid: $('#username').val(),
        password: $('#password').val()
      }),
      contentType: 'application/json',
      dataType: 'json',
      success: res => {
        console.log(res)
        localStorage.setItem('authtoken', res.token)
        initSession(setup)

      }
    })
  })
}

function initCalendar() {
  for (let i = 1; i < 8; i++) {
    $('#header').append(`<th>${daynames[i]}</th>`)
  }
}

function pad(val) {
  return `0${val}`.slice(-2)
}

function renderEditFrame(day, month, data) {
  const $edit = $('#edit')
  $edit.empty()

  $edit.append($('<h3>').text(`Edit day ${month.getFullYear()}-${pad(month.getMonth() + 1)}-${pad(day)}`))
  data.forEach(time => {
    const $t = $('<div>').text(time.shorttime).append($('<button>').text('Delete').click(() => {
      $.ajax({
        type: 'DELETE',
        url: `/v1/time/${time.uuid}`,
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('authtoken'),
        },
        dataType: 'json',
        success: () => {
          editDay(day, month)
        }
      })
    }))
    $edit.append($t)
  })

  $newTime = $('<div>').append($('<input>').prop('id', 'newTime').val('HH:ss').click(function() {
    $(this).val('')
  })).append($('<button>').text('Add').prop('id', 'addButton').click(() => {
    const inString = $('#newTime').val()
    if (!inString.match(/^[0-2][0-9]:[0-6][0-9]$/)) {
      console.log('Bad input')
      return;
    }
    const time = inString.split(':')
    const saveDate = new Date(month.getFullYear(), month.getMonth(), day, ...time, 0)
    const newTime = {
      timestamp: +saveDate,
      shorttime: $('#newTime').val(),
      year: saveDate.getFullYear(),
      month: saveDate.getMonth() + 1,
      day: saveDate.getDate()
    }

    $.ajax({
      type: 'POST',
      url: '/v1/time',
      data: JSON.stringify(newTime),
      contentType: 'application/json',
      headers: {
        'Authorization': 'Bearer ' + localStorage.getItem('authtoken'),
      },
      dataType: 'json',
      success: res => {
        editDay(day, month)
      }
    })
  }))

  $edit.append($newTime)

  $newTime.keyup(event => {
    if(event.keyCode == 13){
      $("#addButton").click();
    }
  });


  $ok = $('<button>').text('Done')
  $ok.click(() => {
    renderDay(day, data)
    $edit.hide();
    $('#content').show()
  })

  $edit.append($ok)
  $edit.show()
  $('#content').hide()
}

function editDay(day, month) {
  $.ajax({
    type: 'GET',
    url: `/v1/time/day/${month.getFullYear()}-${pad(month.getMonth() + 1)}-${pad(day)}`,
    headers: {
      'Authorization': 'Bearer ' + localStorage.getItem('authtoken'),
    },
    dataType: 'json',
    success: data => {
      renderEditFrame(day, month, data)
    }
  })

}

function renderDay(day, data) {
  $(`#day${day}data`).remove()
  if (data.length === 0) {
    return
  }
  const lines = []
  let time = 0

  for (let i = 0; i < data.length; i = i + 2) {
    const start = data[i]
    const end = data[i + 1]
    let line = start.shorttime
    if (end) {
      line += ' - ' + end.shorttime
      time += end.timestamp - start.timestamp;
    } else {
      line += ' - ?'
    }
    lines.push(line)
  }

  /** Round the time calculated for the day to the nearest quarter,
   *  expressed as a decimal fraction of the hour.
   */

  let roundedTime = Math.round(time / 1000 / 60)
  const diff = roundedTime % 15
  if (diff <= 7) {
    roundedTime -= diff
  } else {
    roundedTime += 15 - diff
  }
  roundedTime = roundedTime / 60


  lines.push('');
  lines.push(`Total time: ${roundedTime}`)
  lines.push(`<span class='flex'>Flex: ${roundedTime - workingHours}</span>`)

  const $day = $('<div>').prop('id', `day${day}data`).html(lines.join('<br>'))

  $(`#day${day}`).append($day)
}

function renderMonth(data) {
  Object.keys(data).forEach(key => {
    renderDay(key, data[key])
  })
}

function fetchMonth(month) {
  $.ajax({
    type: 'GET',
    url: `/v1/time/month/${month.getFullYear()}-${pad(month.getMonth() + 1)}`,
    headers: {
      'Authorization': 'Bearer ' + localStorage.getItem('authtoken'),
    },
    dataType: 'json',
    success: renderMonth
  })
}

function initMonth(month) {
  const firstDay = new Date(month.getFullYear(), month.getMonth(), 1).getDay() || 7;
  const numOfDays = new Date(month.getFullYear(), month.getMonth() + 1, 0).getDate()
  $('#edit').hide()
  $('#content').show()

  $('#calendar .week').remove();

  let $week = $('<tr>').addClass('week')
  $('#calendar').append($week)

  for (let i = 1; i < firstDay; i++) {
    $week.append($('<td>').addClass('inactive'))
  }

  let day = 1;

  while (day <= numOfDays) {
    if ($week.children().length >= 7) {
      $week.children().slice(-2).addClass('weekend')
      $week = $('<tr>').addClass('week')
      $('#calendar').append($week)
    }
    $week.append($('<td>').addClass('day').prop('id', `day${day}`).append($('<span>').text(day).addClass('number')))
    const daytoedit = day
    $(`#day${day}`).click(() => {
      window.history.pushState({
        day: daytoedit,
        month: month
      }, 'Edit day')
      editDay(daytoedit, month)
    })
    day += 1
  }

  while ($week.children().length < 7) {
    $week.append($('<td>').addClass('inactive'))
  }
  $week.children().slice(-2).addClass('weekend')

  $('#current').text(monthnames[month.getMonth()])
  $('#previous').text(monthnames[month.getMonth() ? month.getMonth() - 1 : 11])
  $('#next').text(monthnames[(month.getMonth() + 1) % 12])

  $('#previous').off('click')
  $('#next').off('click')

  $('#previous').click(() => {
    const newMonth = new Date(month.getFullYear(),month.getMonth() - 1)
    window.history.pushState({
      month: newMonth
    }, $('#previous').text())
    initMonth(newMonth)
  })
  $('#next').click(() => {
    const newMonth = new Date(month.getFullYear(),month.getMonth() + 1)
    window.history.pushState({
      month: newMonth
    }, $('#next').text())
    initMonth(newMonth)
  })

  fetchMonth(month)
}


window.onpopstate = function(event) {

  if (event.state) {
    if (event.state.day) {
      editDay(event.state.day, event.state.month)
      return
    }
    if (event.state.month) {
      initMonth(event.state.month)
      return
    }
  }
  initMonth(new Date())
}


$(function() {
  $('#content').hide();
  $('#login').hide();
  initSession(() => {
    $('#login').hide()
    initCalendar();
    initMonth(new Date())
    $('#content').show();
  })
  $('#edit').hide();
})

</script>
</head>
<body>

<div id = "edit"></div>
<div id = "login">
  Username: <input id = "username" /><br>
  Password: <input id = "password" /><br>
  <button id="loginButton">Login</button>
</div>

<div id ="content">
<button id="previous"></button>
<span id="current"></span>
<button id="next"></button>
<table id="calendar" border=1>
<tr id="header">
</tr>

</table>
</div>
</body>
</html>
